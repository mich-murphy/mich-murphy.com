<!DOCTYPE html>
<html lang="en">

<head>
    <title>Michael Murphy - Blog</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <meta name="robots" content="noodp"/>

    <link rel="stylesheet" href="https://micha.elmurphy.com/style.css">
    <link rel="stylesheet" href="https://micha.elmurphy.com/color/monokai_pro.css">

        <link rel="stylesheet" href="https://micha.elmurphy.com/color/background_dark.css">
    
        <link rel="stylesheet" href="https://micha.elmurphy.com/font-jetbrainsmono.css">
    
        <link rel="alternate" type="application/rss+xml" title="RSS" href="https://micha.elmurphy.com/rss.xml">
    
        <link rel="shortcut icon" type="image/png" href="/favicon.png">
    
<script data-goatcounter="https://micha.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
</head>

<body class="">
<div class="container">
    
    <header class="header">
        <div class="header__inner">
            <div class="header__logo">
                    
                <a href="https://micha.elmurphy.com" style="text-decoration: none;">
                    <div class="logo">
                      
                            mm
                        
                    </div>
                </a>
            </div>
        </div>

        
        
                <nav class="menu">
            <ul class="menu__inner">
                <li class="active"><a href="https://micha.elmurphy.com">blog</a></li>
            
                <li><a href="https://micha.elmurphy.com/tags">tags</a></li>
            
                <li><a href="https://micha.elmurphy.com/archive">archive</a></li>
            
                <li><a href="https://micha.elmurphy.com/about">about</a></li>
            </ul>
        </nav>
    
    
        
    </header>
    

    <div class="content">
        
    <div class="post">
        
    <h1 class="post-title"><a href="https://micha.elmurphy.com/s3-object-storage/">How To Mount S3 Compatible Object Storage in Ubuntu</a></h1>
    <div class="post-meta-inline">
        
    <span class="post-date">
            2022-11-29
        </span>

    </div>

    
        <span class="post-tags-inline">
                <a class="post-tag" href="https://micha.elmurphy.com/tags/homelab/">#homelab</a>&nbsp;
                <a class="post-tag" href="https://micha.elmurphy.com/tags/s3/">#s3</a>&nbsp;
                <a class="post-tag" href="https://micha.elmurphy.com/tags/ubuntu/">#ubuntu</a></span>
    

        
        <div class="post-content">
            <p>I'm currently in the process of setting up a <a rel="noopener" target="_blank" href="https://linuxhandbook.com/homelab/">homelab</a>, one of the major tasks I want to manage is storage and streaming of music.</p>
<p>For streaming music and managing metadata I'm using <a rel="noopener" target="_blank" href="https://roonlabs.com/">Roon Server</a>, this may change in the future as I explore other options. I store my music on a 2012 Mac Mini (the only computer I had lying around) which is running Ubuntu 20.04 as a VM in <a rel="noopener" target="_blank" href="https://www.proxmox.com/en/">Proxmox</a>. My Mac Mini has 2 x 250GB SSD storage, which has been quickly filling up as my music collection grows.</p>
<span id="continue-reading"></span>
<p>My end goal is to build a dedicated homelab with a large amount of storage, either as <a rel="noopener" target="_blank" href="https://arstechnica.com/information-technology/2020/05/zfs-101-understanding-zfs-storage-and-performance/">ZFS</a> or a combination of <a rel="noopener" target="_blank" href="https://perfectmediaserver.com/tech-stack/mergerfs/">MergerFS</a> and <a rel="noopener" target="_blank" href="https://perfectmediaserver.com/tech-stack/snapraid/">SnapRAID</a>. Unfortunately building a dedicated homelab requires a significant financial contribution. I needed to find an interim solution - that's where S3 compatible object storage comes in.</p>
<p>I hadn't previously used object storage, but had heard it worked well for storing files that don't change frequently e.g. media files and music. After doing some quick research I discovered that I could mount an object store to a computer running Linux, macOS or FreeBSD using <a rel="noopener" target="_blank" href="https://github.com/s3fs-fuse/s3fs-fuse">s3fs-fuse</a>. I decided to test how well this worked by mounting the object store, adding some music to it and then pointing Roon Server to the object store. The steps I followed to mount the object store are detailed in <a rel="noopener" target="_blank" href="https://upcloud.com/resources/tutorials/mount-object-storage-cloud-server-s3fs-fuse">this guide</a>, my own summarised version is below.</p>
<h2 id="mounting-storage">Mounting Storage</h2>
<p>The steps may vary depending on the provider you are using for object storage, for reference I am using <a rel="noopener" target="_blank" href="https://www.linode.com/">Linode</a>.</p>
<h3 id="install-s3fs-fuse">Install s3fs-fuse</h3>
<p>On Ubuntu this is nice and easy, the package name will likely vary depending on your Linux distro:</p>
<pre data-lang="bash" style="background-color:#2e3440;color:#d8dee9;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#88c0d0;">sudo</span><span> apt install s3fs
</span></code></pre>
<h3 id="authentication">Authentication</h3>
<p>After creating an object store you will also need to create access keys. These should be a combination of:</p>
<ol>
<li>An <code>ACCESS_KEY</code></li>
<li>A <code>SECRET_KEY</code></li>
</ol>
<p>We need to store the access key on the machine we plan to mount the object store to, as it will be needed to authenticate the connection:</p>
<pre data-lang="bash" style="background-color:#2e3440;color:#d8dee9;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#88c0d0;">echo </span><span style="color:#a3be8c;">&quot;ACCESS_KEY:SECRET_KEY&quot; </span><span style="color:#81a1c1;">| </span><span style="color:#88c0d0;">sudo</span><span> tee /etc/passwd-s3fs
</span><span style="color:#88c0d0;">sudo</span><span> chmod 600 /etc/passwd-s3fs
</span></code></pre>
<h3 id="mounting">Mounting</h3>
<p>First we need to create the directory the object store will be mounted to:</p>
<pre data-lang="bash" style="background-color:#2e3440;color:#d8dee9;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#88c0d0;">mkdir</span><span> /mnt/my-object-storage
</span></code></pre>
<p>Then we can mount the storage at the directory created above, filling in the placeholders with the appropriate values:</p>
<pre data-lang="bash" style="background-color:#2e3440;color:#d8dee9;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#88c0d0;">sudo</span><span> s3fs {bucketname} {/mnt/my-object-storage} -o passwd_file=/etc/passwd-s3fs -o allow_other -o url=https://{private-network-endpoint}
</span></code></pre>
<ul>
<li><code>{bucketname}</code> = the name of the bucket you wish to mount</li>
<li><code>{/mnt/my-object-storage}</code> = directory to mount to the object store to (created earlier)</li>
<li><code>{private-network-endpoint}</code> = the url given by your provider to the object store e.g. https://ap-south-1.linodeobjects.com</li>
<li>the <code>allow_other</code> flag allows users other than root to have access to the bucket</li>
</ul>
<h3 id="testing">Testing</h3>
<p>Assuming you didn't run into any errors after following the above instructions, you can now test the storage. I did this by opening a web browser and viewing the object store within my account dashboard at Linode, and copying some new files in to the object store on my homelab. If the file match between the web browser and your local machine then its a good sign that things are working. If this isn't the case unmount the storage and try again, double checking the values provided when making the connection.</p>
<h3 id="persisting-after-reboot">Persisting After Reboot</h3>
<p>Now that everything has been mounted properly we can setup an entry within <code>/etc/fstab</code>, so that the object store is mounted whenever the local machine reboots.</p>
<p>First we need to unmount:</p>
<pre data-lang="bash" style="background-color:#2e3440;color:#d8dee9;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#88c0d0;">sudo</span><span> umount /etc/my-object-storage
</span></code></pre>
<p>Then we can edit <code>/etc/fstab</code> in whichever editor you are most comfortable with (<code>vim</code> is the correct answer), and add the following entry on a new line:</p>
<pre data-lang="bash" style="background-color:#2e3440;color:#d8dee9;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#88c0d0;">s3fs#bucketname</span><span> /mnt/my-object-storage fuse _netdev,allow_other,passwd_file=/etc/passwd-s3fs,url=https://ap-south-1.linodeobjects.com/ 0 0
</span></code></pre>
<p>If you want more details on what each of the options do then I recommend checking out the FAQs at the <a rel="noopener" target="_blank" href="https://github.com/s3fs-fuse/s3fs-fuse/wiki/FAQ">s3fs GitHub repo</a></p>
<h2 id="final-thoughts">Final Thoughts</h2>
<p>How well did this work for music streaming? I was able to point Roon to music on the object store, scan tracks and stream music, though there were some limitations in performance:</p>
<ul>
<li>When selecting music to play there was ~3-5 second delay before the track started, when streaming from local storage or Tidal this is pretty much instant</li>
<li>Scanning tracks and collecting metadata with Roon took significantly longer - 1 album on the object store took longer than my entire library of ~1,500 tracks on local storage</li>
<li>Copying data across to the object store took significantly longer than an <code>rsync</code> between machines, which I do between my local homelab and another server outside of my network</li>
</ul>
<p>The above thoughts seem to align with my initial research into object storage - it works well for reading data that doesn't change frequently, once you start copying data across regularly then things slow down. If you are happy to accept a slight delay when first choosing music to play (this doesn't seem to be an issue when moving on to play the next track in an album), then this solution could work well. Backups seem an obvious use case for object storage, I'm currently backing up my Roon settings and library to the object store, I schedule these backups at night and it is working well.</p>

        </div>

        
        <div class="pagination">
            <div class="pagination__title">
                <span class="pagination__title-h">other posts</span>
                <hr />
            </div>
            <div class="pagination__buttons">
                
                    <span class="button next">
                        <a href="https://micha.elmurphy.com/s3-object-storage-nixos/">
                            <span class="button__text">How To Mount S3 Object Storage in NixOS</span>&nbsp;
                            <span class="button__icon">→</span>
                        </a>
                    </span>
                </div>
        </div>
    
    </div>

    </div>

    
<footer class="footer">
    <div class="footer__inner">
            <div class="copyright">
                    <span>© 
    2023
 Michael Murphy</span>
                <span class="copyright-theme">
                    <span class="copyright-theme-sep">| </span>
                    Source code is available on <a href="https://github.com/mich-murphy/micha.elmurphy.com">GitHub</a>
                </span>
            </div>
        </div>
</footer>


</div>
</body>

</html>
