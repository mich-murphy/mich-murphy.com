<!DOCTYPE html>
<html lang="en">

<head>
    <title></title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <meta name="robots" content="noodp"/>

    <link rel="stylesheet" href="https://micha.elmurphy.com/style.css">
    <link rel="stylesheet" href="https://micha.elmurphy.com/color/orange.css">

        <link rel="stylesheet" href="https://micha.elmurphy.com/color/background_dark.css">
    
    <link rel="stylesheet" href="https://micha.elmurphy.com/font-hack.css">

    </head>

<body class="">
<div class="container">
    
    <header class="header">
        <div class="header__inner">
            <div class="header__logo">
                    
                <a href="https://micha.elmurphy.com" style="text-decoration: none;">
                    <div class="logo">
                      
                            mm
                        
                    </div>
                </a>
            </div>
        </div>

        
        
                <nav class="menu">
            <ul class="menu__inner">
                <li class="active"><a href="https://micha.elmurphy.com">blog</a></li>
            
                <li><a href="https://micha.elmurphy.com/tags">tags</a></li>
            
                <li><a href="https://micha.elmurphy.com/archive">archive</a></li>
            
                <li><a href="https://micha.elmurphy.com/about">about me</a></li>
            
                <li><a href="https://github.com/mich-murphy" target="_blank" rel="noopener noreferrer">github</a></li>
            </ul>
        </nav>
    
    
        
    </header>
    

    <div class="content">
        
        <div class="posts">
                <div class="post on-list">
                    
    <h1 class="post-title"><a href="https://micha.elmurphy.com/s3-object-store/">How To Mount S3 Compatible Object Store Using s3fs-fuse</a></h1>
    <div class="post-meta-inline">
        
    <span class="post-date">
            2022-11-29
        </span>

    </div>

    

                    
        <div class="post-content">
            <h1 id="motivations-for-using-object-storage">Motivations For Using Object Storage</h1>
<p>I'm currently in the process of setting up a <a href="https://linuxhandbook.com/homelab/">Homelab</a>, one of the major tasks I want to manage is storage and streaming of music.</p>
<p>For streaming music and managing metadata I'm using <a href="https://roonlabs.com/">Roon Server</a>, this may change in the future as I explore other options. I store my music on a 2012 Mac Mini (the only computer I had lying around) which is running Ubuntu 20.04 as a VM in <a href="https://www.proxmox.com/en/">Proxmox</a>. My Mac Mini has 2 x 250GB SSD storage, which has been quickly filling up as my music collection grows.</p>
<p>My end goal is to build a dedicated Homelab with a large amount of storage, either as <a href="https://arstechnica.com/information-technology/2020/05/zfs-101-understanding-zfs-storage-and-performance/">ZFS</a> or a combination of <a href="https://perfectmediaserver.com/tech-stack/mergerfs/">MergerFS</a> and <a href="https://perfectmediaserver.com/tech-stack/snapraid/">SnapRAID</a>. Unfortunately building a dedicated Homelab requires a significant financial contribution. I needed to find an interim solution - that's where S3 compatible object storage comes in.</p>
<p>I hadn't previously used object storage, but had heard it worked well for storing files that don't change frequently e.g. media files and music. After doing some quick research I discovered that I could mount an object store to a computer running Linux, macOS or FreeBSD using <a href="https://github.com/s3fs-fuse/s3fs-fuse">s3fs-fuse</a>. I decided to test how well this worked by mounting the object store, adding some music to it and then pointing Roon Server to the object store. The steps I followed to mount the object store are detailed in <a href="https://upcloud.com/resources/tutorials/mount-object-storage-cloud-server-s3fs-fuse">this guide</a>, my own summarised version is below.</p>
<h1 id="mounting-object-storage">Mounting Object Storage</h1>
<p>The steps may vary depending on the provider you are using for object storage, for reference I am using <a href="https://www.linode.com/">Linode</a>.</p>
<h2 id="install-s3fs-fuse">Install s3fs-fuse</h2>
<p>On Ubuntu this is nice and easy, the package name will likely vary depending on your Linux distro:</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">sudo</span><span> apt install s3fs
</span></code></pre>
<h2 id="access-keys-authentication">Access Keys &amp; Authentication</h2>
<p>After creating an object store you will also need to create access keys. These should be a combination of:</p>
<ol>
<li>An <code>ACCESS_KEY</code></li>
<li>A <code>SECRET_KEY</code></li>
</ol>
<p>We need to store the access key on the machine we plan to mount the object store to, as it will be needed to authenticate the connection:</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#96b5b4;">echo </span><span>&quot;</span><span style="color:#a3be8c;">ACCESS_KEY:SECRET_KEY</span><span>&quot; | </span><span style="color:#bf616a;">sudo</span><span> tee /etc/passwd-s3fs
</span><span style="color:#bf616a;">sudo</span><span> chmod 600 /etc/passwd-s3fs
</span></code></pre>
<h2 id="mount-storage">Mount Storage</h2>
<p>First we need to create the directory the object store will be mounted to:</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">mkdir</span><span> /mnt/my-object-storage
</span></code></pre>
<p>Then we can mount the storage at the directory created above, filling in the placeholders with the appropriate values:</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">sudo</span><span> s3fs {bucketname} {/mnt/my-object-storage}</span><span style="color:#bf616a;"> -o</span><span> passwd_file=/etc/passwd-s3fs</span><span style="color:#bf616a;"> -o</span><span> allow_other</span><span style="color:#bf616a;"> -o</span><span> url=https://{private-network-endpoint}
</span></code></pre>
<ul>
<li><code>{bucketname}</code> = the name of the bucket you wish to mount</li>
<li><code>{/mnt/my-object-storage}</code> = directory to mount to the object store to (created earlier)</li>
<li><code>{private-network-endpoint}</code> = the url given by your provider to the object store e.g. https://ap-south-1.linodeobjects.com</li>
<li>the <code>allow_other</code> flag allows users other than root to have access to the bucket</li>
</ul>
<h2 id="testing-the-newly-mounted-storage">Testing The Newly Mounted Storage</h2>
<p>Assuming you didn't run into any errors after following the above instructions, you can now test the storage. I did this by opening a web browser and viewing the object store within my account dashboard at Linode, and copying some new files in to the object store on my homelab. If the file match between the web browser and your local machine then its a good sign that things are working. If this isn't the case unmount the storage and try again, double checking the values provided when making the connection.</p>
<h2 id="ensuring-mount-persists-after-reboot">Ensuring Mount Persists After Reboot</h2>
<p>Now that everything has been mounted properly we can setup an entry within <code>/etc/fstab</code>, so that the object store is mounted whenever the local machine reboots.</p>
<p>First we need to unmount:</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">sudo</span><span> umount /etc/my-object-storage
</span></code></pre>
<p>Then we can edit <code>/etc/fstab</code> in whichever editor you are most comfortable with (<code>vim</code> is the correct answer), and add the following entry on a new line:</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">s3fs#bucketname</span><span> /mnt/my-object-storage fuse _netdev,allow_other,passwd_file=/etc/passwd-s3fs,url=https://ap-south-1.linodeobjects.com/ 0 0
</span></code></pre>
<p>If you want more details on what each of the options do then I recommend checking out the FAQs at the <a href="https://github.com/s3fs-fuse/s3fs-fuse/wiki/FAQ">s3fs GitHub repo</a></p>

        </div>

                </div>
            <div class="pagination">
                <div class="pagination__buttons"></div>
            </div>
        </div>
        
    </div>

    
    <footer class="footer">
        <div class="footer__inner">
                <div class="copyright">
                        <span>Â© 
    2022
 Michael Murphy</span>
                    <span class="copyright-theme">
                        <span class="copyright-theme-sep">:: </span>
                        Theme: <a href="https://github.com/pawroman/zola-theme-terminimal/">Terminimal</a> by pawroman
                    </span>
                </div>
            </div>
    </footer>
    

</div>
</body>

</html>
